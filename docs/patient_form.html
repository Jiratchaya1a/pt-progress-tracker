<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</title>

<!-- Flatpickr Thai -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --primary:#1976d2;
    --primary-dark:#115293;
    --accent:#00a89b;
    --muted:#6b7280;
    --danger:#d32f2f;
  }
  *{box-sizing:border-box}
  body {
    font-family: Inter, "Segoe UI", Tahoma, Arial, sans-serif;
    margin:0;
    padding:28px;
    background:var(--bg);
    color:#1f2937;
  }
  h1{margin:0 0 18px 0;font-size:20px;}
  .container{
      width:80%;
      max-width:80%;
      margin:0 auto;  
      padding:0;
  }
  .top-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:18px;}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow:0 6px 18px rgba(20,36,63,0.06);
  }
  .form-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="date"], select{
    width:100%;
    padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;
    font-size:14px;background:#fff;
  }
  .btn {
    background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    font-weight:600; box-shadow:0 4px 10px rgba(25,118,210,0.12)
  }
  .btn:hover{background:var(--primary-dark)}
  .btn-ghost{background:transparent;border:1px solid #d1d5db;color:var(--muted)}
  .btn-danger{background:var(--danger)}
  .actions{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:14px;background:var(--card);border-radius:8px;overflow:hidden}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:13px}
  th{background:linear-gradient(90deg,rgba(25,118,210,0.12),rgba(25,118,210,0.06));color:#0f1724}
  tr:hover td{background:#fbfdff}
  .flex-row{display:flex;gap:10px;align-items:center}
  .tag{padding:6px 8px;border-radius:8px;background:#eef6ff;color:var(--primary);font-size:12px}
  .qr-btn{background:#0b74b3;padding:6px 10px;border-radius:8px;color:white;border:none;cursor:pointer}
  .edit-btn{background:#0b7a4f;padding:6px 10px;border-radius:8px;color:white;border:none;cursor:pointer}
  .del-btn{background:var(--danger);padding:6px 10px;border-radius:8px;color:white;border:none;cursor:pointer}
  .muted-td{color:var(--muted);font-size:12px}
  .footer-note{margin-top:12px;font-size:12px;color:var(--muted)}
  /* Modal */
  #qrModal{display:none;position:fixed;inset:0;background:rgba(10,15,25,0.55);justify-content:center;align-items:center;padding:20px;z-index:9999}
  #qrBox{background:var(--card);padding:20px;border-radius:12px;width:320px;max-width:95%;text-align:center}
  #qrcode{
    margin: 16px auto;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  /* responsive */
  @media (max-width:720px){
    .top-row{flex-direction:column;align-items:stretch}
  }

  .datepicker-popup {
    position: absolute;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    width: 260px;
    z-index: 9999;
  }
  
  .datepicker-popup select {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    margin-bottom: 10px;
  }
  
  .datepicker-popup .day-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }
  
  .datepicker-popup .day {
    padding: 6px 0;
    text-align: center;
    cursor: pointer;
    border-radius: 6px;
    font-size: 13px;
  }
  
  .datepicker-popup .day:hover {
    background: #e3f2fd;
  }
  
  .datepicker-popup .day.disabled {
    color: #ccc;
    pointer-events: none;
  }

  /* ===== Success Popup ===== */
#successPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.success-box {
  background: white;
  border-radius: 16px;
  padding: 30px 36px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  animation: popIn 0.25s ease-out;
}

.checkmark {
  font-size: 64px;
  color: #22c55e; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  margin-bottom: 12px;
}

.success-text {
  font-size: 18px;
  font-weight: 600;
  color: #111827;
}

@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

  
/* =========================
   üì± Mobile Responsive
   ========================= */
@media (max-width: 768px) {

  body {
    padding: 12px;
  }

  .container {
    width: 100%;
    max-width: 100%;
  }

  h1 {
    font-size: 18px;
    line-height: 1.4;
  }

  /* header buttons */
  .top-row {
    gap: 10px;
  }

  .top-row .btn {
    width: 100%;
    justify-content: center;
  }

  /* card spacing */
  .card {
    padding: 14px;
    border-radius: 14px;
  }

  /* form: 1 column on phone */
  .form-grid {
    grid-template-columns: 1fr !important;
    gap: 10px;
  }

  label {
    font-size: 12px;
  }

  input[type="text"],
  select {
    font-size: 15px;
    padding: 10px 12px;
    border-radius: 10px;
  }

  /* buttons */
  .btn {
    padding: 12px;
    font-size: 15px;
    border-radius: 12px;
  }

  .actions,
  .flex-row {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  /* table wrapper */
  table {
    font-size: 12px;
  }

  th, td {
    padding: 8px;
    white-space: nowrap;
  }

  /* hide less important columns on mobile */
  table th:nth-child(4),
  table td:nth-child(4),  /* ‡∏≠‡∏≤‡∏¢‡∏∏ */
  table th:nth-child(9),
  table td:nth-child(9) { /* ‡πÅ‡∏û‡∏ó‡∏¢‡πå */
    display: none;
  }

  /* QR modal */
  #qrBox {
    width: 100%;
    max-width: 100%;
    padding: 16px;
  }

  #qrcode {
    transform: scale(0.9);
  }

  /* footer note */
  .footer-note {
    font-size: 11px;
    line-height: 1.4;
  }
}

@media (max-width: 768px) {

  /* 1) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
  #pageTitle span#thaiDate {
    display: block;
    margin-top: 6px;
    font-size: 14px;
    color: #4b5563;
  }

  /* 2) ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
  #province {
    grid-column: span 1 !important;
    margin-top: 6px;
  }

}

@media (max-width: 768px) {

  /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠+‡πÄ‡∏û‡∏® */
  .form-grid {
    grid-template-columns: 1fr !important;
  }

  .field-fullname,
  .field-gender {
    display: block;
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö 2 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  .field-fullname {
    grid-column: 1 / span 2;
  }

  .field-gender {
    grid-column: 3 / span 1;
  }

  /* ‡∏™‡∏£‡πâ‡∏≤‡∏á layout 2:1 */
  .form-grid {
    grid-template-columns: 2fr 1fr !important;
  }

}



</style>
</head>

<body>
<div class="container">
  <div class="top-row">
    <div>
      <h1 class="card" id="pageTitle" style="padding:14px 18px;display:inline-block">
        ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span id="thaiDate"></span>
      </h1>
    </div>
  
  </div>

  <div class="card" style="margin-bottom:14px;">
    <form id="patientForm" onsubmit="return false;">

    <!-- ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å 3 ‡∏ä‡πà‡∏≠‡∏á -->
    <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
      <div>
        <label>HN</label><input id="hn" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™ HN">
      </div>
      <div>
        <label>CID</label><input id="cid" type="text" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
      </div>
      <div>
        <label>AN</label><input id="an" type="text" placeholder="AN (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
      </div>
    </div>
        
      <div class="form-grid" style="margin-top:12px;">
      
      <!-- ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• -->
      <div class="field-fullname">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input id="fullname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      
      <!-- ‡πÄ‡∏û‡∏® -->
      <div class="field-gender">
        <label>‡πÄ‡∏û‡∏®</label>
        <select id="gender">
          <option>‡∏ä‡∏≤‡∏¢</option>
          <option>‡∏´‡∏ç‡∏¥‡∏á</option>
        </select>
      </div>

        <!-- ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î -->
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
          <input id="dob" type="text" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î" readonly>
        </div>
        <div id="dobPicker" class="datepicker-popup" style="display:none"></div>
      
        <!-- ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ -->
        <div style="grid-column: span 2;">
          <label>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
          <select id="insurance">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ --</option>
            <option>‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á (UC)</option>
            <option>‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á ‡∏ó.1</option>
            <option>‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á ‡∏ó.2</option>
            <option>‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á ‡∏ó.3</option>
            <option>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ)</option>
            <option>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏ó‡∏´‡∏≤‡∏£/‡∏ï‡∏≥‡∏£‡∏ß‡∏à</option>
            <option>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
            <option>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (SSO)</option>
            <option>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏°.33</option>
            <option>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏°.39</option>
            <option>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏°.40</option>
            <option>‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏ö‡∏¥‡∏Å ‡∏≠‡∏õ‡∏ó.)</option>
            <option>‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏£‡∏Å‡πÄ‡∏Å‡∏¥‡∏î</option>
            <option>‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (UCEP Plus)</option>
            <option>‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô</option>
            <option>‡∏£‡∏±‡∏ê‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à</option>
            <option>‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (UCEP)</option>
            <option>‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û</option>
            <option>‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÇ‡∏£‡∏Ñ‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á</option>
            <option>‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ß (‡∏ö‡∏±‡∏ï‡∏£‡∏ä‡∏°‡∏û‡∏π)</option>
            <option>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏≠‡∏á</option>
          </select>
        </div>
      
        <!-- ‚¨á‚¨á ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà) ‚¨á‚¨á -->
      
        <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà) -->
        <div>
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
          <input id="phone" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678">
        </div>
      
        <!-- ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏î‡∏¥‡∏°) -->
        <div>
          <label>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
          <input id="house_no" type="text">
        </div>
      
        <div>
          <label>‡∏´‡∏°‡∏π‡πà</label><input id="moo" type="text">
        </div>
      
        <div>
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><select id="province" onchange="updateDistricts()"></select>
        </div>
      
        <div>
          <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label><select id="district" onchange="updateSubdistricts()"></select>
        </div>
      
        <div>
        <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
        <select id="subdistrict" onchange="updateZipcode()"></select>
        </div>
      
        <!-- ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á input ‡∏≠‡∏∑‡πà‡∏ô -->
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
          <input id="zipcode" type="text" readonly style="background:white; color:black;">
        </div>
      
        <div>
          <label>‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î</label>
          <select id="pt">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î --</option>
            <option>‡∏Å‡∏†.‡πÄ‡∏ô‡∏ï‡∏¥‡∏°‡∏≤ ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì</option>
            <option>‡∏Å‡∏†.‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏û‡∏£‡∏´‡∏°‡∏à‡∏£‡∏±‡∏™</option>
            <option>‡∏Å‡∏†.‡∏õ‡∏¥‡πà‡∏ô‡∏ä‡∏ô‡∏Å ‡∏û‡∏£‡∏´‡∏°‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡πå</option>
            <option>‡∏Å‡∏†.‡∏à‡∏£‡∏¥‡∏¢‡∏≤ ‡∏ê‡∏¥‡∏ô‡∏∞‡∏Å‡∏∏‡∏•</option>
          </select>
        </div>
      
        <div>
          <label>‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input id="drug_allergy" type="text">
        </div>
      
        <div>
          <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input id="chronic_disease" type="text">
        </div>
      
        <div style="grid-column: span 2;">
          <label>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input id="diagnosis" type="text">
        </div>
      
      </div>

  
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="saveBtn" type="button" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</button>
        <button id="cancelEditBtn" type="button" class="btn btn-ghost" style="display:none">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <div style="margin-left:auto" class="small muted-td">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalCount">0</span></div>
      </div>
  
    </form>
  </div>

  <!-- table -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</div>
      <div><input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN/‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå..." style="padding:8px;border-radius:8px;border:1px solid #e6e9ef"></div>
    </div>

    <div style="overflow:auto">
        <div id="loadingMsg" class="small" style="display:none; margin:10px 0; color:#6b7280;">
          ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...
        </div>
      <table id="patientTable">
        <thead>
          <tr>
            <th>#</th>
            <th>HN</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
            <th>‡πÄ‡∏û‡∏®</th>
            <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
            <th>Dx</th>
            <th>‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="patientTbody"></tbody>
      </table>
    </div>

    <div class="footer-note">TIP: ‡∏Å‡∏î "QR" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå assessment_form.html (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</div>
  </div>

</div>

<!-- QR Modal -->
<div id="qrModal">
  <div id="qrBox" class="card">
    <h3 style="margin:0 0 8px 0">QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h3>
    <div id="qrcode"></div>
    <div id="qrPatientName" style="font-weight:600;margin-top:10px"></div>
    <div style="margin-top:12px;display:flex;justify-content:center;gap:10px">
      <button id="qrClose" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button>
      <a id="qrOpenLink" class="btn" target="_blank" style="text-decoration:none;color:white">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a>
    </div>
  </div>
</div>

<script>
/* ---------------------------------------------------
   Custom Datepicker (Dropdown ‡∏õ‡∏µ ‡∏û.‡∏®.)
--------------------------------------------------- */

const dobInput = document.getElementById("dob");
const picker = document.getElementById("dobPicker");

// Year dropdown (‡∏û.‡∏®.)
function generateYearOptions() {
  let html = `<select id="yearSelect">`;
  const thisYearBE = new Date().getFullYear() + 543;

  for (let y = thisYearBE; y >= 2400; y--) {
    html += `<option value="${y}">${y}</option>`;
  }
  html += `</select>`;
  return html;
}

// Month dropdown (‡πÑ‡∏ó‡∏¢)
function generateMonthOptions() {
  const months = [
    "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
    "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
  ];
  let html = `<select id="monthSelect">`;
  months.forEach((m, i) => html += `<option value="${i}">${m}</option>`);
  html += `</select>`;
  return html;
}

// Generate day grid
function generateDays(yearBE, month) {
  const yearCE = yearBE - 543;
  const firstDay = new Date(yearCE, month, 1).getDay();
  const daysInMonth = new Date(yearCE, month + 1, 0).getDate();

  let html = `<div class="day-grid">`;

  for (let i = 0; i < firstDay; i++) html += `<div></div>`;

  for (let d = 1; d <= daysInMonth; d++) {
    html += `<div class="day" data-day="${d}">${d}</div>`;
  }

  html += `</div>`;
  return html;
}

// Open datepicker
dobInput.addEventListener("click", () => {
  picker.style.display = "block";
  picker.style.position = "absolute";
  picker.style.top = `${dobInput.offsetTop + dobInput.offsetHeight + 6}px`;
  picker.style.left = `${dobInput.offsetLeft}px`;

  picker.innerHTML =
    generateYearOptions() +
    generateMonthOptions() +
    `<div id="dayContainer"></div>`;

  updateCalendar();
});

// Update calendar UI
function updateCalendar() {
  const yearBE = parseInt(document.getElementById("yearSelect").value);
  const month = parseInt(document.getElementById("monthSelect").value);

  document.getElementById("dayContainer").innerHTML =
    generateDays(yearBE, month);

  document.querySelectorAll(".day").forEach(dayEl => {
    dayEl.addEventListener("click", () => {
      const d = dayEl.dataset.day;
      const yearCE = yearBE - 543;

      // ‡∏Ñ‡πà‡∏≤ ‡∏Ñ.‡∏®. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á
      const finalDate = `${yearCE}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

      // üëâ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
      dobInput.value = formatThaiDOB(finalDate);

      // üëâ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏ß‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏ / save
      dobInput.dataset.value = finalDate;

      dobInput.style.color = "black";
      picker.style.display = "none";
    });
  });
}


// Thai short months
function monthThai(m) {
  const arr = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.",
               "‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
  return arr[m];
}

// When change year/month ‚Üí update days
document.addEventListener("change", e => {
  if (e.target.id === "yearSelect" || e.target.id === "monthSelect") {
    updateCalendar();
  }
});

// Close picker if click outside
document.addEventListener("click", e => {
  if (!picker.contains(e.target) && e.target !== dobInput) {
    picker.style.display = "none";
  }
});

function formatThaiDOB(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  const thMonths = [
    "‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.",
    "‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."
  ];
  return `${d.getDate()} ${thMonths[d.getMonth()]} ${d.getFullYear() + 543}`;
}


/* ------------ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢ (‡∏û.‡∏®.) ------------ */
function formatThaiDate(date = new Date()) {
  const thMonths = [
    "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.",
    "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."
  ];
  const d = date.getDate();
  const m = thMonths[date.getMonth()];
  const y = date.getFullYear() + 543;
  return `${d} ${m} ${y}`;
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
document.getElementById("thaiDate").innerText = formatThaiDate();


// ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
document.getElementById("thaiDate").innerText = `‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate()}`;

/* ------------ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏• (‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®) ------------ */

let provinces = [];
let districts = [];      // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
let subDistricts = [];   // ‡∏ï‡∏≥‡∏ö‡∏•

Promise.all([
  fetch('province.json').then(r => r.json()),
  fetch('district.json').then(r => r.json()),        // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
  fetch('sub_district.json').then(r => r.json())     // ‡∏ï‡∏≥‡∏ö‡∏•
]).then(([p, d, sd]) => {
  provinces = p;
  districts = d;
  subDistricts = sd;
  renderProvinces();
}).catch(err => {
  console.error('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err);
});



function renderProvinces(){
  const el = document.getElementById('province');
  el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
  provinces.forEach(p=>{
    el.innerHTML += `<option value="${p.id}">${p.name_th}</option>`;
  });
}

function updateDistricts() {
  const provId = document.getElementById('province').value;
  const dEl = document.getElementById('district');

  dEl.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>';
  document.getElementById('subdistrict').innerHTML =
    '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>';

  districts
    .filter(d => d.province_id == provId)
    .forEach(d => {
      dEl.innerHTML += `<option value="${d.id}">${d.name_th}</option>`;
    });
}

function updateSubdistricts() {
  const distId = document.getElementById('district').value;
  const subEl = document.getElementById('subdistrict');

  subEl.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>';
  document.getElementById('zipcode').value = '';

  subDistricts
    .filter(sd => sd.district_id == distId)
    .forEach(sd => {
      subEl.innerHTML += `
        <option value="${sd.name_th}" data-zip="${sd.zip_code}">
          ${sd.name_th}
        </option>`;
    });
}

function updateZipcode() {
  const subEl = document.getElementById('subdistrict');
  const zipInput = document.getElementById('zipcode');

  const selected = subEl.selectedOptions[0];
  if (!selected) {
    zipInput.value = '';
    return;
  }

  zipInput.value = selected.dataset.zip || '';
}




/* ------------ helpers ------------ */
function calculateAge(dob){
  if(!dob) return '';
  const b = new Date(dob);
  const t = new Date();
  let years = t.getFullYear() - b.getFullYear();
  let months = t.getMonth() - b.getMonth();
  let days = t.getDate() - b.getDate();
  if(days < 0){ months--; days += new Date(t.getFullYear(), t.getMonth(), 0).getDate(); }
  if(months < 0){ years--; months += 12; }
  return `${years} ‡∏õ‡∏µ ${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${days} ‡∏ß‡∏±‡∏ô`;
}

/* ------------ LocalStorage logic ------------ */
const STORAGE_KEY = 'ptPatients';
let patients = []; // array of objects
let editingId = null;

function loadFromLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    patients = raw ? JSON.parse(raw) : [];
  }catch(e){
    patients = [];
    console.error('failed load', e);
  }
  renderTable();
}

function saveToLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(patients));
  document.getElementById('totalCount').innerText = patients.length;
}

function loadFromGoogleSheet() {
  const loadingEl = document.getElementById("loadingMsg");
  const tableEl = document.getElementById("patientTable");

  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î
  loadingEl.style.display = "block";
  tableEl.style.opacity = "0.4";

  fetch(GOOGLE_API_URL)
    .then(res => res.text())
    .then(text => {
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("‚ùå JSON parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", text);
        throw new Error("‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON");
      }

      if (!Array.isArray(data)) {
        console.error("‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", data);
        alert("Google Sheet ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array");
        return;
      }

      patients = data.map(p => ({
        ...p,
        dob: p.dob ? new Date(p.dob).toISOString().slice(0,10) : ''
      }));

      renderTable();
      document.getElementById('totalCount').innerText = patients.length;
    })
    .catch(err => {
      console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏î‡πâ");
    })
    .finally(() => {
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î
      loadingEl.style.display = "none";
      tableEl.style.opacity = "1";
    });
}


/* ------------ render table (with search) ------------ */
function renderTable(filter=''){
  const tbody = document.getElementById('patientTbody');
  tbody.innerHTML = '';
  const list = patients.slice().reverse(); // latest first
  const q = filter.trim().toLowerCase();
  let idx = 0;
  for(let p of list){
    const searchable = `${p.hn} ${p.fullname} ${p.phone} ${p.diagnosis}`.toLowerCase();
    if(q && !searchable.includes(q)) continue;
    idx++;
    const age = calculateAge(p.dob);
    const addr = `${p.house_no ? p.house_no + ' ' : ''}${p.moo ? '‡∏´‡∏°‡∏π‡πà ' + p.moo + ' ' : ''}${p.subdistrict ? p.subdistrict + ' ' : ''}${p.district ? p.district + ' ' : ''}${p.province ? p.province : ''}`.trim();
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${idx}</td>
        <td class="muted-td">${escapeHtml(p.hn)}</td>
        <td>${escapeHtml(p.fullname)}</td>
        <td>${age}</td>
        <td>${escapeHtml(p.gender)}</td>
        <td>${escapeHtml(addr)}</td>
        <td>${escapeHtml(p.phone)}</td>
        <td>${escapeHtml(p.diagnosis)}</td>
        <td>${escapeHtml(p.pt || "")}</td>
       <td>${escapeHtml(p.created_at ? new Date(p.created_at).toLocaleDateString("th-TH") : "")}</td>
        <td>
          <div style="display:flex;gap:6px">
            <button class="qr-btn" onclick="openQR('${p.id}')">QR</button>
            <button class="edit-btn" onclick="startEdit('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="del-btn" onclick="deletePatient('${p.id}')">‡∏•‡∏ö</button>
          </div>
        </td>
      </tr>
    `);
  }
  document.getElementById('totalCount').innerText = patients.length;
}

/* safe html */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];});
}

/* ------------ add / edit / delete ------------ */
function collectForm(){
  const provEl = document.getElementById('province');
  const distEl = document.getElementById('district');
  const subEl  = document.getElementById('subdistrict');

  return {
    id: editingId || 'p' + Date.now(),
    hn: hn.value.trim(),
    cid: cid.value.trim(),
    an: an.value.trim(),
    fullname: fullname.value.trim(),
    gender: gender.value,
    dob: dob.dataset.value || '',
    insurance: insurance.value,

    house_no: house_no.value.trim(),
    moo: moo.value.trim(),

    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á id + name
    province_id: provEl.value,
    province: provEl.selectedOptions[0]?.text || '',

    district_id: distEl.value,
    district: distEl.selectedOptions[0]?.text || '',

    subdistrict: subEl.value,
    zipcode: zipcode.value,

    phone: phone.value.trim(),
    pt: pt.value,
    drug_allergy: drug_allergy.value.trim(),
    chronic_disease: chronic_disease.value.trim(),
    diagnosis: diagnosis.value.trim()
  };
}


function validateForm(p){
  if(!p.hn || !p.fullname || !p.dob || !p.diagnosis){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å HN, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢');
    return false;
  }
  return true;
}

const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbyBghZHBLkPuZwiNNYL5uW-8iQ24JBFPJrfEQsFLTblIezzXBcf6jEBrPuYbUGMfax0/exec";

document.getElementById('saveBtn').addEventListener('click', () => {
  const p = collectForm();
  if (!validateForm(p)) return;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á timestamp
  p.created_at = new Date().toISOString();

  /* -----------------------------
      1) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage
  ------------------------------*/
  if (editingId) {
    patients = patients.map(x => x.id === editingId ? p : x);
    editingId = null;
    document.getElementById('saveBtn').innerText = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
    document.getElementById('cancelEditBtn').style.display = 'none';
  } else {
    patients.push(p);
  }

  saveToLocal();
  renderTable();
  clearForm();
  showSuccessPopup();


  /* -----------------------------
      2) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet
  ------------------------------*/
  fetch(GOOGLE_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    body: JSON.stringify(p)
  })
  .then(async res => {
      const text = await res.text();
      try {
          const json = JSON.parse(text);
          console.log("‚úî ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", json);
      } catch (err) {
          console.error("‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON:", text);
          alert("Google Script ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:\n" + text);
      }
  })
  .then(result => {
    console.log("‚úî ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", result);
  })
  .catch(err => {
    console.error("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
    alert("‚ö† ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet ‡πÑ‡∏î‡πâ");
  });
});

function startEdit(id){
  const p = patients.find(x => x.id === id);
  if(!p) return;
  editingId = id;
  // fill form
  document.getElementById('hn').value = p.hn;
  document.getElementById('cid').value = p.cid;
  document.getElementById('an').value = p.an;
  document.getElementById('fullname').value = p.fullname;
  document.getElementById('gender').value = p.gender || '‡∏ä‡∏≤‡∏¢';
  document.getElementById('dob').value = formatThaiDOB(p.dob);
  document.getElementById('dob').dataset.value = p.dob;
  // update flatpickr altInput if exists
  const fp = document.querySelector("#dob");
  if (fp && p.dob && fp._flatpickr) {
    fp._flatpickr.setDate(p.dob, true);
    const d = new Date(p.dob);
    fp._flatpickr.altInput.value =
      `${d.getDate()} ${fp._flatpickr.l10n.months.longhand[d.getMonth()]} ${d.getFullYear() + 543}`;
  }
  document.getElementById('insurance').value = p.insurance || '';
  document.getElementById('house_no').value = p.house_no || '';
  document.getElementById('moo').value = p.moo || '';
  document.getElementById('province').value = p.province_id;
  updateDistricts();
  
  document.getElementById('district').value = p.district_id;
  updateSubdistricts();
  
  document.getElementById('subdistrict').value = p.subdistrict;
  document.getElementById('zipcode').value = p.zipcode || '';
  document.getElementById('phone').value = p.phone || '';
  document.getElementById('pt').value = p.pt || '';
  document.getElementById('drug_allergy').value = p.drug_allergy || '';
  document.getElementById('chronic_disease').value = p.chronic_disease || '';
  document.getElementById('diagnosis').value = p.diagnosis || '';

  document.getElementById('saveBtn').innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  document.getElementById('cancelEditBtn').style.display = 'inline-block';
  window.scrollTo({top:0,behavior:'smooth'});
}

document.getElementById('cancelEditBtn').addEventListener('click', () => {
  editingId = null;
  clearForm();
  document.getElementById('saveBtn').innerText = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
  document.getElementById('cancelEditBtn').style.display = 'none';
});

function deletePatient(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  patients = patients.filter(x => x.id !== id);
  saveToLocal();
  renderTable();
}

/* ------------ clear form ------------ */
function clearForm(){
  ['hn','cid','an','fullname','gender','dob','insurance','house_no','moo','province','district','subdistrict','zipcode','phone','pt','drug_allergy','chronic_disease','diagnosis'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.tagName.toLowerCase()==='select') el.selectedIndex=0;
    else el.value = '';
  });
  // reset flatpickr alt
  const fp = document.querySelector("#dob");
  if(fp && fp._flatpickr) fp._flatpickr.clear();
}

/* ------------ QR logic ------------ */
const assessmentBaseUrl = "https://jiratchaya1a.github.io/pt-progress-tracker/docs/assessment_form.html";
function openQR(patientId){
  const p = patients.find(x => x.id === patientId);
  if(!p) return;
  const link = `${assessmentBaseUrl}?hn=${encodeURIComponent(p.hn)}&name=${encodeURIComponent(p.fullname)}`;
  document.getElementById('qrcode').innerHTML = '';
  document.getElementById('qrPatientName').innerText = `${p.fullname} (${p.hn})`;
  new QRCode(document.getElementById('qrcode'), { text: link, width:220, height:220 });
  document.getElementById('qrOpenLink').href = link;
  document.getElementById('qrModal').style.display = 'flex';
}
document.getElementById('qrClose').addEventListener('click', ()=> document.getElementById('qrModal').style.display='none');
document.getElementById('qrModal').addEventListener('click', (e)=> { if(e.target.id==='qrModal') document.getElementById('qrModal').style.display='none'; });


/* search */
document.getElementById('searchInput').addEventListener('input', (e)=> renderTable(e.target.value));

/* ------------ init ------------ */
loadFromGoogleSheet();
  
/* optionally show example if empty */
// if(patients.length===0){ /* could seed sample */ }

/* ensure total count */
document.getElementById('totalCount').innerText = patients.length;

/* ------------ helper: on load focus ------------- */
window.addEventListener('load', ()=> {
  // If GitHub Pages online and you want the QR to link to hosted assessment page,
  // change assessmentBaseUrl to full url: "https://jiratchaya1a.github.io/pt-progress-tracker/assessment_form.html"
});

function showSuccessPopup() {
  const popup = document.getElementById('successPopup');
  popup.style.display = 'flex';

  setTimeout(() => {
    popup.style.display = 'none';
  }, 1500); // ‡πÅ‡∏™‡∏î‡∏á 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}

/* End script */
</script>
  
<!-- Success Popup -->
<div id="successPopup" style="display:none;">
  <div class="success-box">
    <div class="checkmark">‚úî</div>
    <div class="success-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>
  </div>
</div>
  
</body>
</html>
