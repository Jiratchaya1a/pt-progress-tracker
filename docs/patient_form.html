<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</title>

<!-- Flatpickr Thai -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>

<!-- QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --primary:#1976d2;
    --primary-dark:#115293;
    --muted:#6b7280;
    --danger:#d32f2f;
  }
  *{box-sizing:border-box}
  body {
    font-family: Inter, "Segoe UI", Tahoma, Arial, sans-serif;
    margin:0;
    padding:28px;
    background:var(--bg);
    color:#1f2937;
  }
  h1{margin:0 0 18px 0;font-size:20px;}
  .container{max-width:1100px;margin:0 auto;}
  .top-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:18px;}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow:0 6px 18px rgba(20,36,63,0.06);
  }
  .form-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], select{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #e6e9ef;
    font-size:14px;
    background:#fff;
  }
  #zipcode{
    background:#eef3ff;
    border:1px solid #b9c9ff;
    font-weight:600;
    text-align:center;
    letter-spacing:1px;
    color:#1a237e;
  }
  .btn {
    background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    font-weight:600; box-shadow:0 4px 10px rgba(25,118,210,0.12)
  }
  .btn:hover{background:var(--primary-dark)}
  .btn-ghost{background:transparent;border:1px solid #d1d5db;color:var(--muted)}
  .btn-danger{background:var(--danger)}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:14px;background:var(--card);border-radius:8px;overflow:hidden}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:13px}
  th{background:linear-gradient(90deg,rgba(25,118,210,0.12),rgba(25,118,210,0.06));color:#0f1724}
  tr:hover td{background:#fbfdff}

  /* Modal */
  #qrModal{display:none;position:fixed;inset:0;background:rgba(10,15,25,0.55);
    justify-content:center;align-items:center;padding:20px;z-index:9999}
  #qrBox{background:var(--card);padding:20px;border-radius:12px;width:320px;max-width:95%;text-align:center}
</style>
</head>
<body>
<div class="container">

  <!-- TITLE WITH THAI DATE -->
  <div class="top-row">
    <div>
      <h1 class="card" id="pageTitle" style="padding:14px 18px;display:inline-block"></h1>
      <div class="small" style="margin-top:6px">
        ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (LocalStorage) ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏°‡πâ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:10px;">
      <button class="btn" id="exportBtn">Export</button>
      <button class="btn btn-ghost" id="importBtn">Import</button>
      <button class="btn btn-ghost" id="clearAllBtn">Clear All</button>
    </div>
  </div>

  <!-- FORM -->
  <div class="card" style="margin-bottom:14px;">
    <form id="patientForm" onsubmit="return false;">
      <div class="form-grid">

        <div><label>HN</label><input id="hn" type="text"></div>
        <div><label>CID</label><input id="cid" type="text"></div>
        <div><label>AN</label><input id="an" type="text"></div>

        <div><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="fullname" type="text"></div>
        <div>
          <label>‡πÄ‡∏û‡∏®</label>
          <select id="gender"><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option></select>
        </div>

        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
          <input id="dob" type="text" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î">
        </div>

        <div style="grid-column: span 2;">
          <label>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
          <select id="insurance">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ --</option>
            <option>‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á (UC)</option>
            <option>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option>
            <option>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
            <option>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏≠‡∏á</option>
          </select>
        </div>

        <div><label>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input id="house_no" type="text"></div>
        <div><label>‡∏´‡∏°‡∏π‡πà</label><input id="moo" type="text"></div>
        <div><label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><select id="province" onchange="updateDistricts()"></select></div>
        <div><label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label><select id="district" onchange="updateSubdistricts()"></select></div>
        <div><label>‡∏ï‡∏≥‡∏ö‡∏•</label><select id="subdistrict"></select></div>
        <div><label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label><input id="zipcode" readonly></div>

        <div><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="phone" type="text"></div>
        <div><label>‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î</label>
          <select id="pt">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option>‡∏Å‡∏†.‡πÄ‡∏ô‡∏ï‡∏¥‡∏°‡∏≤</option>
            <option>‡∏Å‡∏†.‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</option>
            <option>‡∏Å‡∏†.‡∏õ‡∏¥‡πà‡∏ô‡∏ä‡∏ô‡∏Å</option>
            <option>‡∏Å‡∏†.‡∏à‡∏£‡∏¥‡∏¢‡∏≤</option>
          </select>
        </div>

        <div><label>‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input id="drug_allergy" type="text"></div>
        <div><label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input id="chronic_disease" type="text"></div>
        <div style="grid-column: span 2;">
          <label>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input id="diagnosis" type="text">
        </div>

      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="saveBtn" type="button" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</button>
        <button id="cancelEditBtn" type="button" class="btn btn-ghost" style="display:none">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <div style="margin-left:auto" class="small">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalCount">0</span></div>
      </div>
    </form>
  </div>

  <!-- TABLE -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <div class="small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
      <input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="padding:8px;border-radius:8px;border:1px solid #ddd">
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th><th>HN</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡πÄ‡∏û‡∏®</th><th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>Dx</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="patientTbody"></tbody>
    </table>
  </div>
</div>

<!-- QR MODAL -->
<div id="qrModal">
  <div id="qrBox">
    <h3>QR Code</h3>
    <div id="qrcode"></div>
    <div id="qrPatientName" style="margin-top:10px;font-weight:600"></div>
    <button id="qrClose" class="btn btn-ghost" style="margin-top:14px">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
/* ----------- Thai Date Title ----------- */
function formatThaiDate(d=new Date()){
  const thMonths=["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
  return `${d.getDate()} ${thMonths[d.getMonth()]} ${d.getFullYear()+543}`;
}
document.getElementById("pageTitle").innerHTML =
  `‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate()}`;

/* ----------- Flatpickr DOB (B.E.) ----------- */
flatpickr("#dob", {
  locale: "th",
  altInput: true,
  altFormat: "d F Y",
  dateFormat: "Y-m-d",
  onChange: function(d,_,inst){
    if(d.length){
      inst.altInput.value =
        `${d[0].getDate()} ${inst.l10n.months.longhand[d[0].getMonth()]} ${d[0].getFullYear()+543}`;
    }
  }
});

/* ----------- Load Address JSON ----------- */
let addressData = {};

fetch("data/thai-address.json")
  .then(r=>r.json())
  .then(json=>{
    addressData=json;
    loadProvinces();
  });

function loadProvinces(){
  const el=province;
  el.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
  Object.keys(addressData).forEach(p=>{
    el.innerHTML+=`<option>${p}</option>`;
  });
}

function updateDistricts(){
  district.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>';
  subdistrict.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>';
  zipcode.value="";
  if(!province.value) return;

  Object.keys(addressData[province.value]).forEach(d=>{
    district.innerHTML+=`<option>${d}</option>`;
  });
}

function updateSubdistricts(){
  subdistrict.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>';
  zipcode.value="";
  if(!province.value || !district.value) return;

  addressData[province.value][district.value].forEach(item=>{
    subdistrict.innerHTML+=`<option data-zip="${item.zip}">${item.name}</option>`;
  });
}

subdistrict.addEventListener("change",()=>{
  zipcode.value=subdistrict.selectedOptions[0]?.dataset.zip || "";
});

/* ----------- Helper: Age ----------- */
function calculateAge(dob){
  if(!dob) return "";
  const b=new Date(dob), t=new Date();
  let y=t.getFullYear()-b.getFullYear();
  let m=t.getMonth()-b.getMonth();
  let d=t.getDate()-b.getDate();
  if(d<0){m--; d+=30;}
  if(m<0){y--; m+=12;}
  return `${y} ‡∏õ‡∏µ ${m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${d} ‡∏ß‡∏±‡∏ô`;
}

/* ----------- LocalStorage Logic ----------- */
const STORAGE_KEY="ptPatients";
let patients=[];
let editingId=null;

function loadFromLocal(){
  patients = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  renderTable();
}
function saveToLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(patients));
  totalCount.innerText=patients.length;
}

/* ----------- Render Table ----------- */
function renderTable(q=""){
  let tbody=patientTbody;
  tbody.innerHTML="";
  const list=patients.slice().reverse();
  q=q.toLowerCase();
  let idx=0;

  list.forEach(p=>{
    if(q && !`${p.hn} ${p.fullname} ${p.phone}`.toLowerCase().includes(q)) return;
    idx++;
    const addr=`${p.house_no} ‡∏°.${p.moo} ${p.subdistrict} ${p.district} ${p.province}`;
    tbody.innerHTML+=`
      <tr>
        <td>${idx}</td>
        <td>${p.hn}</td>
        <td>${p.fullname}</td>
        <td>${calculateAge(p.dob)}</td>
        <td>${p.gender}</td>
        <td>${addr}</td>
        <td>${p.phone}</td>
        <td>${p.diagnosis}</td>
        <td>
          <button onclick="editPatient('${p.id}')" class="btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </td>
      </tr>`;
  });

  totalCount.innerText=patients.length;
}

searchInput.addEventListener("input",e=>renderTable(e.target.value));

/* ----------- Add/Edit ----------- */
function collect(){
  return {
    id: editingId || "p"+Date.now(),
    hn: hn.value.trim(),
    cid: cid.value.trim(),
    an: an.value.trim(),
    fullname: fullname.value.trim(),
    gender: gender.value,
    dob: dob.value,
    insurance: insurance.value,
    house_no: house_no.value.trim(),
    moo: moo.value.trim(),
    province: province.value,
    district: district.value,
    subdistrict: subdistrict.value,
    zipcode: zipcode.value,
    phone: phone.value.trim(),
    pt: pt.value,
    drug_allergy: drug_allergy.value.trim(),
    chronic_disease: chronic_disease.value.trim(),
    diagnosis: diagnosis.value.trim()
  };
}

saveBtn.addEventListener("click",()=>{
  const p=collect();
  if(!p.hn || !p.fullname || !p.dob || !p.diagnosis){
    return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å HN, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢");
  }

  if(editingId){
    patients = patients.map(x=>x.id===editingId?p:x);
    editingId=null;
    cancelEditBtn.style.display="none";
    saveBtn.innerText="‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢";
  } else {
    patients.push(p);
  }

  saveToLocal();
  renderTable();
  patientForm.reset();
});

/* ----------- Edit ----------- */
function editPatient(id){
  const p=patients.find(x=>x.id===id);
  if(!p) return;
  editingId=id;

  Object.keys(p).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value=p[k];
  });

  updateDistricts();
  district.value=p.district;
  updateSubdistricts();
  subdistrict.value=p.subdistrict;

  saveBtn.innerText="üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
  cancelEditBtn.style.display="inline-block";
  window.scrollTo({top:0,behavior:"smooth"});
}

cancelEditBtn.addEventListener("click",()=>{
  editingId=null;
  patientForm.reset();
  saveBtn.innerText="‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢";
  cancelEditBtn.style.display="none";
});

/* ----------- Clear All ----------- */
clearAllBtn.addEventListener("click",()=>{
  if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    patients=[];
    saveToLocal();
    renderTable();
  }
});

/* ----------- Init ----------- */
loadFromLocal();
</script>

</body>
</html>
